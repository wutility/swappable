(function(o,h){typeof exports=="object"&&typeof module<"u"?module.exports=h():typeof define=="function"&&define.amd?define(h):(o=typeof globalThis<"u"?globalThis:o||self,o.Swappable=h())})(this,function(){"use strict";class o{container;options;itemsData=[];isDragging=!1;isMoving=!1;draggedItem=null;targetItem=null;ghostElement=null;dragRAF=null;eventListeners={};itemRects=new Map;ghostOffset={x:0,y:0};animatingElements=new Set;layoutAnimationCounter=0;boundHandleDragStart=this._handleDragStart.bind(this);boundThrottledDragMove=this._throttledDragMove.bind(this);boundHandleDragEnd=this._handleDragEnd.bind(this);constructor(t,e={}){if(typeof t=="string")this.container=document.querySelector(t);else if(t instanceof HTMLElement)this.container=t;else throw new Error("Swappable: Invalid container provided. Must be a selector string or an HTMLElement.");if(!this.container)throw new Error("Swappable: Container not found.");const i={dragEnabled:!0,dragHandle:null,layoutDuration:300,swapDuration:300,layoutEasing:"ease",itemsPerRow:4,classNames:{item:"grid-item",drag:"dragging",placeholder:"placeholder",ghost:"ghost",hidden:"hidden"}};this.options={...i,...e},this.options.classNames={...i.classNames,...e.classNames},this._setCSSVar("--items-per-row",String(this.options.itemsPerRow)),this._setCSSVar("--layout-duration",`${this.options.layoutDuration}ms`),this._setCSSVar("--layout-easing",this.options.layoutEasing),this.container.classList.add("swappable-grid"),this._initItems(),this._bindEvents()}_setCSSVar(t,e){this.container.style.setProperty(t,e)}_initItems(){this.itemsData=[],Array.from(this.container.children).forEach((e,i)=>{e.classList.contains(this.options.classNames.item)||e.classList.add(this.options.classNames.item),this.itemsData.push({index:i,element:e})})}_getEventCoords(t){return{clientX:t.clientX,clientY:t.clientY}}_bindEvents(){this.container.addEventListener("pointerdown",this.boundHandleDragStart,{passive:!1})}_handleDragStart(t){if(t.button!==0||!this.options.dragEnabled)return;const e=t.target,i=this.options.dragHandle?e.closest(this.options.dragHandle):e;if(!i)return;const s=`.${this.options.classNames.item}`,a=i.closest(s);a&&(t.preventDefault(),this.isDragging=!0,this.draggedItem=a,this.draggedItem.style.willChange="transform",this.draggedItem.classList.add(this.options.classNames.hidden),this.itemRects.clear(),this.itemsData.forEach(({element:n})=>{n!==this.draggedItem&&this.itemRects.set(n,n.getBoundingClientRect())}),this._createGhost(t),window.addEventListener("pointermove",this.boundThrottledDragMove,{passive:!1}),window.addEventListener("pointerup",this.boundHandleDragEnd),window.addEventListener("pointercancel",this.boundHandleDragEnd),this._triggerEvent("dragStart",{item:this.draggedItem,event:t}))}_throttledDragMove(t){this.isMoving||(this.dragRAF&&cancelAnimationFrame(this.dragRAF),this.dragRAF=requestAnimationFrame(()=>{this._handleDragMove(t),this.isMoving=!1,this.dragRAF=null}),this.isMoving=!0)}_handleDragMove(t){!this.isDragging||!this.draggedItem||(t.preventDefault(),this._moveGhost(t),this._findAndHighlightTarget(t),this._triggerEvent("dragMove",{item:this.draggedItem,event:t}))}_handleDragEnd(t){!this.isDragging||!this.draggedItem||(this.targetItem&&this.targetItem!==this.draggedItem&&this._sortItems(this.draggedItem,this.targetItem),this._finalizeDragEnd(t))}_createGhost(t){if(!this.draggedItem)return;const e=this._getEventCoords(t),i=this.draggedItem.getBoundingClientRect();this.ghostElement=this.draggedItem.cloneNode(!0),this.ghostElement.classList.add(this.options.classNames.drag,this.options.classNames.ghost),this.draggedItem.classList.add(this.options.classNames.drag),this.ghostElement.classList.remove(this.options.classNames.hidden),Object.assign(this.ghostElement.style,{width:`${i.width}px`,height:`${i.height}px`,top:`${i.top}px`,left:`${i.left}px`}),this.ghostOffset={x:e.clientX-i.left,y:e.clientY-i.top},document.body.appendChild(this.ghostElement),this._moveGhost(t)}_moveGhost(t){if(!this.ghostElement)return;const e=this._getEventCoords(t);this.ghostElement.style.left=`${e.clientX-this.ghostOffset.x}px`,this.ghostElement.style.top=`${e.clientY-this.ghostOffset.y}px`}_findAndHighlightTarget(t){this.targetItem&&(this.targetItem.style.willChange="initial",this.targetItem.classList.remove(this.options.classNames.placeholder),this.targetItem=null);const{clientX:e,clientY:i}=this._getEventCoords(t);let s=null;for(const[a,n]of this.itemRects.entries())if(e>=n.left&&e<=n.right&&i>=n.top&&i<=n.bottom){s=a;break}s&&(this.targetItem=s,this.targetItem.style.willChange="transform",this.targetItem.classList.add(this.options.classNames.placeholder))}_sortItems(t,e){const i=this.itemsData.findIndex(a=>a.element===t),s=this.itemsData.findIndex(a=>a.element===e);i===-1||s===-1||i===s||(this.swap(i,s),this._triggerEvent("sort",{fromIndex:i,toIndex:s,items:this.itemsData}))}_finalizeDragEnd(t){const e=this.draggedItem;this.dragRAF&&(cancelAnimationFrame(this.dragRAF),this.dragRAF=null),this._cleanupDragState(),e&&this._triggerEvent("dragEnd",{item:e,event:t})}_cleanupDragState(){this.ghostElement&&this.ghostElement.remove(),this.draggedItem&&(this.draggedItem.style.willChange="initial",this.draggedItem.classList.remove(this.options.classNames.drag),this.draggedItem.classList.remove(this.options.classNames.hidden)),this.targetItem&&(this.targetItem.style.willChange="initial",this.targetItem.classList.remove(this.options.classNames.placeholder)),this.isDragging=!1,this.isMoving=!1,this.draggedItem=null,this.targetItem=null,this.ghostElement=null,this.itemRects.clear(),window.removeEventListener("pointermove",this.boundThrottledDragMove),window.removeEventListener("pointerup",this.boundHandleDragEnd),window.removeEventListener("pointercancel",this.boundHandleDragEnd)}_triggerEvent(t,e){const i=this.eventListeners[t];typeof i=="function"&&i(e)}on(t,e){return typeof e=="function"&&(this.eventListeners[t]=e),this}off(t){return this.eventListeners[t]=void 0,this}layout(t){this._triggerEvent("layoutStart",void 0);const e=typeof t=="number"?t:this.options.layoutDuration;this._setCSSVar("--layout-duration",`${e}ms`);const i=this.itemsData.map(a=>a.element),s=i.map(a=>a.getBoundingClientRect());this.animatingElements.clear(),this.layoutAnimationCounter=0,this.itemsData.forEach((a,n)=>{const r=this.container.children[n];r!==a.element&&this.container.insertBefore(a.element,r||null)}),requestAnimationFrame(()=>{const a=[];if(i.forEach((n,r)=>{n.style.willChange="transform";const l=s[r],d=n.getBoundingClientRect(),g=l.left-d.left,m=l.top-d.top;g||m?(a.push(n),n.classList.remove("animating"),n.style.transform=`translate(${g}px, ${m}px)`):n.style.transform="translate(0, 0)"}),a.length===0){this._triggerEvent("layoutEnd",void 0);return}this.layoutAnimationCounter=a.length,requestAnimationFrame(()=>{a.forEach(n=>{this.animatingElements.add(n),n.classList.add("animating"),n.style.transform="translate(0, 0)";const r=()=>{n.style.willChange="initial",n.classList.remove("animating"),this.animatingElements.delete(n),n.removeEventListener("transitionend",r),this.layoutAnimationCounter--,this.layoutAnimationCounter<=0&&this._triggerEvent("layoutEnd",void 0)};n.addEventListener("transitionend",r,{once:!0})})})})}add(t,e){t.classList.add(this.options.classNames.item);let i;if(e!=null&&e>=0&&e<this.itemsData.length){this.itemsData.splice(e,0,{index:e,element:t}),this.container.insertBefore(t,this.container.children[e]);for(let s=e;s<this.itemsData.length;s++)this.itemsData[s].index=s;i=this.itemsData[e]}else i={index:this.itemsData.length,element:t},this.itemsData.push(i),this.container.appendChild(t);return this._triggerEvent("add",{items:this.itemsData.map(s=>s.element)}),i}remove(t){let e;if(t instanceof HTMLElement?e=this.itemsData.findIndex(s=>s.element===t):e=t,e<0||e>=this.itemsData.length)return null;const[i]=this.itemsData.splice(e,1);i.element.classList.remove("animating"),this.animatingElements.delete(i.element),i.element.remove();for(let s=e;s<this.itemsData.length;s++)this.itemsData[s].index=s;return this._triggerEvent("remove",{items:this.itemsData.map(s=>s.element)}),i}select(t){return typeof t=="number"?this.itemsData[t]||null:this.itemsData.find(i=>i.element===t)||null}swap(t,e){return t<0||t>=this.itemsData.length||e<0||e>=this.itemsData.length||t===e?this:([this.itemsData[t],this.itemsData[e]]=[this.itemsData[e],this.itemsData[t]],this.itemsData[t].index=t,this.itemsData[e].index=e,this.layout(this.options.swapDuration),this._triggerEvent("swap",{fromIndex:t,toIndex:e,item:this.itemsData[e].element}),this)}refresh(){this._initItems(),this.itemsData.forEach((t,e)=>{const i=this.container.children[e];i!==t.element&&this.container.insertBefore(t.element,i||null)}),this.layout(this.options.layoutDuration)}destroy(){this.detach(),this.itemsData.forEach(({element:t})=>{t.classList.remove("animating")}),this.container.innerHTML="",this.itemsData=[],this.eventListeners={},this.animatingElements.clear(),this.layoutAnimationCounter=0}detach(){this.container.removeEventListener("pointerdown",this.boundHandleDragStart),this.dragRAF&&(cancelAnimationFrame(this.dragRAF),this.dragRAF=null),this._cleanupDragState()}enable(){this.options.dragEnabled||(this.options.dragEnabled=!0,this._bindEvents())}disable(){this.options.dragEnabled&&(this.options.dragEnabled=!1,this.detach())}}return o});
