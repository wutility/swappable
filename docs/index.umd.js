(function(h,l){typeof exports=="object"&&typeof module<"u"?module.exports=l():typeof define=="function"&&define.amd?define(l):(h=typeof globalThis<"u"?globalThis:h||self,h.Swappable=l())})(this,function(){"use strict";const h={dragEnabled:!0,dragHandle:".grid-item",layoutDuration:300,swapDuration:300,layoutEasing:"ease",itemsPerRow:4,longPressDelay:100,dragSlop:5,ghostFactory:void 0,classNames:{item:"grid-item",drag:"dragging",placeholder:"placeholder",ghost:"ghost",hidden:"hidden"}};class l{container;options;itemsData=[];isPotentialDrag=!1;isDragging=!1;isMoving=!1;startEvent=null;longPressTimeout=null;draggedItem=null;targetItem=null;ghostElement=null;dragRAF=null;eventListeners={};ghostOffset={x:0,y:0};layoutId=0;boundHandleDragStart=this._handleDragStart.bind(this);boundThrottledDragMove=this._throttledDragMove.bind(this);boundHandleDragEnd=this._handleDragEnd.bind(this);constructor(t,e={}){const i=t instanceof HTMLElement?t:document.querySelector(t);if(!i)throw new Error("Swappable: Container not found.");this.container=i,this.options={...h,...e},this.options.classNames={...h.classNames,...e.classNames},this.container.style.setProperty("--items-per-row",String(this.options.itemsPerRow)),this.container.style.setProperty("--layout-duration",`${this.options.layoutDuration}ms`),this.container.style.setProperty("--layout-easing",this.options.layoutEasing),this.container.classList.add("swappable-grid"),this._initItems(),this._bindEvents()}_initItems(){this.itemsData=[],Array.from(this.container.children).forEach((e,i)=>{e.classList.add(this.options.classNames.item),this.itemsData.push({index:i,element:e})})}_getEventCoords(t){return{clientX:t.clientX,clientY:t.clientY}}_bindEvents(){this.container.addEventListener("pointerdown",this.boundHandleDragStart,{passive:!0})}_handleDragStart(t){if(t.button!==0||!this.options.dragEnabled||this.isDragging)return;const e=t.target.closest(this.options.dragHandle);if(!e)return;const i=e.closest(`.${this.options.classNames.item}`);i&&(this.isPotentialDrag=!0,this.startEvent=t,this.draggedItem=i,this.longPressTimeout=window.setTimeout(()=>{this.isPotentialDrag&&this._initializeDrag(this.startEvent)},this.options.longPressDelay),window.addEventListener("pointermove",this.boundThrottledDragMove,{passive:!1}),window.addEventListener("pointerup",this.boundHandleDragEnd,{once:!0}),window.addEventListener("pointercancel",this.boundHandleDragEnd,{once:!0}))}_initializeDrag(t){this.draggedItem&&(this.isDragging=!0,this.isPotentialDrag=!1,this.draggedItem.style.willChange="transform",this.draggedItem.classList.add(this.options.classNames.hidden),this._createGhost(t),this._triggerEvent("dragStart",{item:this.draggedItem,event:t}))}_throttledDragMove(t){if(this.isPotentialDrag){const e=this._getEventCoords(this.startEvent),i=this._getEventCoords(t);if(Math.hypot(i.clientX-e.clientX,i.clientY-e.clientY)>this.options.dragSlop){this._cleanupDragState();return}}this.isDragging&&t.preventDefault(),!this.isMoving&&this.isDragging&&(this.dragRAF=requestAnimationFrame(()=>{this._handleDragMove(t),this.isMoving=!1}),this.isMoving=!0)}_handleDragMove(t){this.draggedItem&&(this._moveGhost(t),this._findAndHighlightTarget(t),this._triggerEvent("dragMove",{item:this.draggedItem,event:t}))}_handleDragEnd(t){if(this.dragRAF&&cancelAnimationFrame(this.dragRAF),this.isDragging&&this.draggedItem&&this.targetItem&&this.targetItem!==this.draggedItem){const s=this.itemsData.findIndex(r=>r.element===this.draggedItem),n=this.itemsData.findIndex(r=>r.element===this.targetItem);s!==-1&&n!==-1&&(this.swap(s,n),this._triggerEvent("sort",{oldIndex:s,newIndex:n,items:this.itemsData}))}const e=this.draggedItem,i=this.isDragging;this._cleanupDragState(),i&&e&&this._triggerEvent("dragEnd",{item:e,event:t})}_cleanupDragState(){this.longPressTimeout&&clearTimeout(this.longPressTimeout),this.ghostElement?.remove(),this.draggedItem&&(this.draggedItem.style.willChange="",this.draggedItem.classList.remove(this.options.classNames.drag,this.options.classNames.hidden)),this.targetItem&&this.targetItem.classList.remove(this.options.classNames.placeholder),this.isPotentialDrag=this.isDragging=this.isMoving=!1,this.draggedItem=this.targetItem=this.ghostElement=this.startEvent=this.longPressTimeout=this.dragRAF=null,window.removeEventListener("pointermove",this.boundThrottledDragMove),window.removeEventListener("pointerup",this.boundHandleDragEnd),window.removeEventListener("pointercancel",this.boundHandleDragEnd)}_createGhost(t){if(!this.draggedItem)return;const e=this.draggedItem.getBoundingClientRect(),i=this._getEventCoords(t);this.ghostElement=this.options.ghostFactory?this.options.ghostFactory(this.draggedItem):this.draggedItem.cloneNode(!0);const s=this.ghostElement.style;s.position="fixed",s.boxSizing="border-box",s.width=`${e.width}px`,s.height=`${e.height}px`,s.top=`${e.top}px`,s.left=`${e.left}px`,s.pointerEvents="none",s.zIndex="1000",this.ghostElement.classList.add(this.options.classNames.ghost,this.options.classNames.drag),this.draggedItem.classList.add(this.options.classNames.drag),this.ghostElement.classList.remove("hidden"),this.ghostOffset={x:i.clientX-e.left,y:i.clientY-e.top},document.body.appendChild(this.ghostElement)}_moveGhost(t){if(!this.ghostElement)return;const e=this._getEventCoords(t);this.ghostElement.style.transform=`translate(${e.clientX-this.ghostOffset.x-this.ghostElement.offsetLeft}px, ${e.clientY-this.ghostOffset.y-this.ghostElement.offsetTop}px)`}_findAndHighlightTarget(t){this.targetItem&&this.targetItem.classList.remove(this.options.classNames.placeholder);const{clientX:e,clientY:i}=this._getEventCoords(t),s=this.container.getBoundingClientRect(),n=e-s.left,r=i-s.top;let a=null;if(n>=0&&n<=s.width&&r>=0&&r<=s.height){const o=this.itemsData[0]?.element.getBoundingClientRect();if(!o||o.height===0)return;const d=Math.min(Math.floor(n/(s.width/this.options.itemsPerRow)),this.options.itemsPerRow-1),g=Math.floor(r/o.height),m=Math.min(g*this.options.itemsPerRow+d,this.itemsData.length-1);a=this.itemsData[m]?.element}a&&a!==this.draggedItem?(this.targetItem=a,this.targetItem.classList.add(this.options.classNames.placeholder)):this.targetItem=null}_triggerEvent(t,e){this.eventListeners[t]?.(e)}on(t,e){return typeof e=="function"&&(this.eventListeners[t]=e),this}off(t){return this.eventListeners[t]=void 0,this}layout(t){this._triggerEvent("layoutStart",void 0);const e=++this.layoutId;this.container.style.setProperty("--layout-duration",`${t??this.options.layoutDuration}ms`);const i=this.itemsData.map(n=>n.element),s=i.map(n=>n.getBoundingClientRect());this.itemsData.forEach((n,r)=>{const a=this.container.children[r];a!==n.element&&this.container.insertBefore(n.element,a||null)}),requestAnimationFrame(()=>{const n=i.filter((r,a)=>{const o=r.getBoundingClientRect(),d=s[a].left-o.left,g=s[a].top-o.top;return d||g?(r.style.transform=`translate(${d}px, ${g}px)`,!0):!1});if(n.length===0){this._triggerEvent("layoutEnd",void 0);return}requestAnimationFrame(()=>{let r=0;n.forEach(a=>{const o=()=>{this.layoutId===e&&(a.style.willChange="",a.classList.remove("animating"),a.removeEventListener("transitionend",o),++r===n.length&&this._triggerEvent("layoutEnd",void 0))};a.addEventListener("transitionend",o),a.style.willChange="transform",a.classList.add("animating"),a.style.transform=""})})})}swap(t,e){return t===e||Math.min(t,e)<0||Math.max(t,e)>=this.itemsData.length?this:([this.itemsData[t],this.itemsData[e]]=[this.itemsData[e],this.itemsData[t]],this.itemsData[t].index=t,this.itemsData[e].index=e,this.layout(this.options.swapDuration),this._triggerEvent("swap",{fromIndex:t,toIndex:e,fromElement:this.itemsData[e].element,toElement:this.itemsData[t].element}),this)}destroy(){this.detach(),this.container.innerHTML="",this.itemsData=[],this.eventListeners={}}detach(){this.container.removeEventListener("pointerdown",this.boundHandleDragStart),this._cleanupDragState()}refresh(){this._initItems(),this.itemsData.forEach((t,e)=>{const i=this.container.children[e];i!==t.element&&this.container.insertBefore(t.element,i||null)}),this.layout()}select(t){return typeof t=="number"?this.itemsData[t]||null:this.itemsData.find(e=>e.element===t)||null}add(t,e){t.classList.add(this.options.classNames.item);let i;if(e!=null&&e>=0&&e<this.itemsData.length){this.itemsData.splice(e,0,{index:e,element:t}),this.container.insertBefore(t,this.container.children[e]);for(let s=e;s<this.itemsData.length;s++)this.itemsData[s].index=s;i=this.itemsData[e]}else i={index:this.itemsData.length,element:t},this.itemsData.push(i),this.container.appendChild(t);return this._triggerEvent("add",{items:this.itemsData.map(s=>s.element)}),i}remove(t){let e;if(t instanceof HTMLElement?e=this.itemsData.findIndex(s=>s.element===t):e=t,e<0||e>=this.itemsData.length)return null;const[i]=this.itemsData.splice(e,1);i.element.remove();for(let s=e;s<this.itemsData.length;s++)this.itemsData[s].index=s;return this._triggerEvent("remove",{items:this.itemsData.map(s=>s.element)}),i}enable(){this.options.dragEnabled||(this.options.dragEnabled=!0,this._bindEvents())}disable(){this.options.dragEnabled&&(this.options.dragEnabled=!1,this.detach())}}return l});
