(function(g,m){typeof exports=="object"&&typeof module<"u"?module.exports=m():typeof define=="function"&&define.amd?define(m):(g=typeof globalThis<"u"?globalThis:g||self,g.Swappable=m())})(this,function(){"use strict";const g={dragEnabled:!0,dragHandle:".grid-item",layoutDuration:300,swapDuration:300,layoutEasing:"ease",itemsPerRow:4,longPressDelay:100,dragSlop:5,classNames:{item:"grid-item",drag:"dragging",placeholder:"placeholder",ghost:"ghost",hidden:"hidden"}};class m{container;itemsData=[];options;isPotentialDrag=!1;isDragging=!1;startEvent=null;longPressTimeout=null;draggedItem=null;targetItem=null;ghostElement=null;dragRAF=null;eventListeners={};ghostOffset={x:0,y:0};containerRectCache=null;itemHeightCache=0;constructor(t,e={}){const s=t instanceof HTMLElement?t:document.querySelector(t);if(!s)throw new Error("Swappable: Container not found.");this.container=s,this.options={...g,...e,ghostFactory:e.ghostFactory},this.options.classNames={...g.classNames,...e.classNames},this.container.style.setProperty("--items-per-row",String(this.options.itemsPerRow)),this.container.style.setProperty("--layout-duration",`${this.options.layoutDuration}ms`),this.container.style.setProperty("--layout-easing",this.options.layoutEasing),this.container.classList.add("swappable-grid"),this._initItems(),this._bindEvents()}_initItems(){this.itemsData=[],Array.from(this.container.children).forEach((e,s)=>{e.classList.add(this.options.classNames.item),this.itemsData.push({index:s,element:e})})}_getEventCoords=t=>({clientX:t.clientX,clientY:t.clientY});_bindEvents=()=>this.container.addEventListener("pointerdown",this._handleDragStart,{passive:!0});_handleDragStart=t=>{if(t.button!==0||!this.options.dragEnabled||this.isDragging)return;const e=t.target.closest(this.options.dragHandle);if(!e)return;const s=e.closest(`.${this.options.classNames.item}`);s&&(this.isPotentialDrag=!0,this.startEvent=t,this.draggedItem=s,this.longPressTimeout=window.setTimeout(()=>{this.isPotentialDrag&&this._initializeDrag(this.startEvent)},this.options.longPressDelay),window.addEventListener("pointermove",this._throttledDragMove,{passive:!1}),window.addEventListener("pointerup",this._handleDragEnd,{once:!0}),window.addEventListener("pointercancel",this._handleDragEnd,{once:!0}))};_initializeDrag=t=>{this.draggedItem&&(this.isDragging=!0,this.isPotentialDrag=!1,this.draggedItem.style.willChange="transform",this.draggedItem.classList.add(this.options.classNames.hidden),this.containerRectCache=this.container.getBoundingClientRect(),this.itemHeightCache=this.itemsData[0]?.element.offsetHeight||0,this._createGhost(t),this._triggerEvent("dragStart",{item:this.draggedItem,event:t}))};_throttledDragMove=t=>{if(this.isPotentialDrag){const e=this._getEventCoords(this.startEvent),s=this._getEventCoords(t);if(Math.hypot(s.clientX-e.clientX,s.clientY-e.clientY)>this.options.dragSlop){this._cleanupDragState();return}}this.isDragging&&(t.preventDefault(),this.dragRAF&&cancelAnimationFrame(this.dragRAF),this.dragRAF=requestAnimationFrame(()=>this._handleDragMove(t)))};_handleDragMove=t=>{this.draggedItem&&(this._moveGhost(t),this._findAndHighlightTarget(t),this._triggerEvent("dragMove",{item:this.draggedItem,event:t}))};_handleDragEnd=t=>{if(this.dragRAF&&cancelAnimationFrame(this.dragRAF),this.isDragging&&this.draggedItem&&this.targetItem&&this.targetItem!==this.draggedItem){const i=this.itemsData.findIndex(n=>n.element===this.draggedItem),a=this.itemsData.findIndex(n=>n.element===this.targetItem);i!==-1&&a!==-1&&(this.swap(i,a),this._triggerEvent("sort",{oldIndex:i,newIndex:a,items:this.itemsData}))}const e=this.draggedItem,s=this.isDragging;this._cleanupDragState(),s&&e&&this._triggerEvent("dragEnd",{item:e,event:t})};_cleanupDragState=()=>{this.longPressTimeout&&clearTimeout(this.longPressTimeout),this.ghostElement?.remove(),this.draggedItem&&(this.draggedItem.style.willChange="",this.draggedItem.classList.remove(this.options.classNames.drag,this.options.classNames.hidden)),this.targetItem&&this.targetItem.classList.remove(this.options.classNames.placeholder),this.isPotentialDrag=this.isDragging=!1,this.draggedItem=this.targetItem=this.ghostElement=this.startEvent=this.longPressTimeout=this.dragRAF=null,this.containerRectCache=null,this.itemHeightCache=0,window.removeEventListener("pointermove",this._throttledDragMove),window.removeEventListener("pointerup",this._handleDragEnd),window.removeEventListener("pointercancel",this._handleDragEnd)};_createGhost=t=>{if(!this.draggedItem)return;const e=this.draggedItem.getBoundingClientRect(),s=this._getEventCoords(t);this.ghostElement=this.options.ghostFactory?this.options.ghostFactory(this.draggedItem):this.draggedItem.cloneNode(!0);const i=this.ghostElement.style;i.position="fixed",i.boxSizing="border-box",i.width=`${e.width}px`,i.height=`${e.height}px`,i.top=`${e.top}px`,i.left=`${e.left}px`,i.pointerEvents="none",i.zIndex="1000",this.ghostElement.classList.add(this.options.classNames.ghost,this.options.classNames.drag),this.ghostElement.classList.remove("hidden"),this.ghostOffset={x:s.clientX-e.left,y:s.clientY-e.top},document.body.appendChild(this.ghostElement)};_moveGhost=t=>{if(!this.ghostElement)return;const e=this._getEventCoords(t);this.ghostElement.style.transform=`translate(${e.clientX-this.ghostOffset.x-this.ghostElement.offsetLeft}px, ${e.clientY-this.ghostOffset.y-this.ghostElement.offsetTop}px)`};_findAndHighlightTarget=t=>{this.targetItem&&this.targetItem.classList.remove(this.options.classNames.placeholder);const{clientX:e,clientY:s}=this._getEventCoords(t),i=this.containerRectCache,a=this.itemHeightCache;if(!i||a===0)return;const n=e-i.left,r=s-i.top;let o=null;if(n>=0&&n<=i.width&&r>=0&&r<=i.height){const h=Math.min(Math.floor(n/(i.width/this.options.itemsPerRow)),this.options.itemsPerRow-1),l=Math.floor(r/a),d=Math.min(l*this.options.itemsPerRow+h,this.itemsData.length-1);o=this.itemsData[d]?.element}o&&o!==this.draggedItem?(this.targetItem=o,this.targetItem.classList.add(this.options.classNames.placeholder)):this.targetItem=null};_triggerEvent(t,e){this.eventListeners[t]?.(e)}on(t,e){return typeof e=="function"&&(this.eventListeners[t]=e),this}off(t){return this.eventListeners[t]=void 0,this}layout(t){this._triggerEvent("layoutStart",void 0);const e=t??this.options.layoutDuration,s=this.itemsData.map(n=>n.element),i=s.map(n=>n.getBoundingClientRect());this.itemsData.forEach((n,r)=>{const o=this.container.children[r];o!==n.element&&this.container.insertBefore(n.element,o||null)});const a=s.map(n=>n.getBoundingClientRect());requestAnimationFrame(()=>{let n=0;const r=[];if(s.forEach((o,h)=>{const l=i[h].left-a[h].left,d=i[h].top-a[h].top;(l||d)&&(o.style.transform=`translate(${l}px, ${d}px)`,o.style.transition="none",r.push(o))}),r.length===0){this._triggerEvent("layoutEnd",void 0);return}requestAnimationFrame(()=>{r.forEach(h=>{const l=d=>{if(d.propertyName!=="transform")return;const c=d.target;c.style.willChange="",c.style.transition="",c.removeEventListener("transitionend",l),++n===r.length&&this._triggerEvent("layoutEnd",void 0)};h.addEventListener("transitionend",l,{once:!0}),h.style.willChange="transform",h.style.transition=`transform ${e}ms ${this.options.layoutEasing}`,h.style.transform=""});const o=setTimeout(()=>{this._triggerEvent("layoutEnd",void 0)},e+50);++n===r.length&&(clearTimeout(o),this._triggerEvent("layoutEnd",void 0))})})}_internalSwap=(t,e)=>([this.itemsData[t],this.itemsData[e]]=[this.itemsData[e],this.itemsData[t]],this.itemsData[t].index=t,this.itemsData[e].index=e,this.layout(this.options.swapDuration),this);_internalAdd=(t,e)=>{t.classList.add(this.options.classNames.item);const s=e??this.itemsData.length,i={index:s,element:t};this.itemsData.splice(s,0,i),this.container.insertBefore(t,this.container.children[s]||null);for(let a=s;a<this.itemsData.length;a++)this.itemsData[a].index=a;return this._triggerEvent("add",{items:this.itemsData.map(a=>a.element)}),i};_internalRemove=t=>{const e=t instanceof HTMLElement?this.itemsData.findIndex(i=>i.element===t):t;if(e<0||e>=this.itemsData.length)return null;const[s]=this.itemsData.splice(e,1);s.element.remove();for(let i=e;i<this.itemsData.length;i++)this.itemsData[i].index=i;return this._triggerEvent("remove",{items:this.itemsData.map(i=>i.element)}),s};swap=this._internalSwap;add=this._internalAdd;remove=this._internalRemove;enable=()=>{this.options.dragEnabled||(this.options.dragEnabled=!0,this._bindEvents())};disable=()=>{this.options.dragEnabled&&(this.options.dragEnabled=!1,this.detach())};detach=()=>{this.container.removeEventListener("pointerdown",this._handleDragStart),this._cleanupDragState()};destroy=()=>{this.detach(),this.container.innerHTML="",this.itemsData=[],this.eventListeners={}};refresh=()=>{this._initItems(),this.layout(0)};select=t=>typeof t=="number"?this.itemsData[t]||null:this.itemsData.find(e=>e.element===t)||null;getSize=()=>this.itemsData.length}return m});
